---
slideinit: "<section markdown=\"1\" data-background=\"../../../../../img/slidebackground.png\"><section markdown=\"1\">"
vertical: "</section><section markdown=\"1\">"
horizontal: "</section></section><section markdown=\"1\" data-background=\"../../../../../img/slidebackground.png\"><section markdown=\"1\">"
layout: post
title: QE实践详解
author: yyyu200
tags: DFT 原创
subtitle: ""
category: Blogs
notebookfilename: intro
visualworkflow: true
published: true
theme: beige
trans: cube
---


* TOC
{:toc}

# QE实践详解

## 1. 计算半导体SiC的能带

计算分为三个步骤：1. 优化晶格常数；2. 自洽计算；3. 能带计算。

### 1.1 设置结构参数

碳化硅SiC有多种结构，这里选择了比较简单的闪锌矿(Zincblende)结构。下面介绍结构信息的获取，已经了解可以直接阅读1.2节，闪锌矿结构的空间群是$F \overline{4}3M$（No. 216），布拉伐格子是面心立方（Face centered cubic）。计算需要知道SiC的原胞尺寸、原子坐标和晶格常数，这些参数是从实验得到的，除了从文献获取外，这里推荐一个数据库[Crystallography Open Database](http://www.crystallography.net/cod/)（COD）。打开COD主页，点击左侧的"search"。

<p align="center">
    <img src="../../../../../img/COD_send_search.png" width="300" />
</p>

在搜索页面“1 to 8 elements”一栏输入Si和C，“number of distinct elements min and max”一栏输入2和2，表示搜索Si和C元素组成的二元化合物，点击“send”开始搜索。搜索的结果包含了数据库中的SiC二元化合物的多种组分及结构，其中有两个空间群为F-43m是我们要找的闪锌矿结构，晶格常数略有不同，分别是4.348和4.358，选择自己喜欢的一个，考虑到后面要计算晶格常数的理论值，这里的选择没有什么影响。

<p align="center">
    <img src="../../../../../img/COD_search_results.png" width="600" />
</p>

点击[CIF](http://www.crystallography.net/cod/1010995.cif)下载后缀为cif的文件。用[VESTA](http://www.jp-minerals.org/vesta/en/download.html)打开，（或使用其他可视化程序，如Material Studio等）。在VESTA中，点击“File”——“Export Data”，选择VASP的POSCAR格式，将文件保存为“SiC.vasp”文件。

```
Si C
1.0
        4.3480000496         0.0000000000         0.0000000000
        0.0000000000         4.3480000496         0.0000000000
        0.0000000000         0.0000000000         4.3480000496
   Si    C
    4    4
Direct
     0.000000000         0.000000000         0.000000000
     0.000000000         0.500000000         0.500000000
     0.500000000         0.000000000         0.500000000
     0.500000000         0.500000000         0.000000000
     0.250000000         0.250000000         0.250000000
     0.750000000         0.750000000         0.250000000
     0.750000000         0.250000000         0.750000000
     0.250000000         0.750000000         0.750000000

```
这时得到的文件包括了cell尺寸（第3-5行）和原子坐标（第9-16行）。需要注意的是，导入cif文件得到是晶胞，有可能不是原胞，为了转化为原胞，最简单的方法是借助Material Studio的建模功能，也可以参考[这里表格2](../../07/TransCell/#tab2)，得到从晶胞到原胞的转换矩阵，输入VESTA中得到原胞，再用VESTA输出POSCAR格式。在VESTA中点击“Edit”——“Edit Data”——“Unit Cell”——“Transform”，输入转换矩阵如下图。

<p align="center">
    <img src="../../../../../img/transform.png" />
</p>

得到的结构文件如下，我们需要将其改成pw.x输入格式。
```
Si C
1.0
        3.0745003223         0.0000000000         0.0000000000
        1.5372501612         2.6625953831         0.0000000000
        1.5372501612         0.8875317944         2.5103190013
   Si    C
    1    1
Direct
     0.000000000         0.000000000         0.000000000
     0.250000000         0.250000000         0.250000000
```

除了上述方法，将晶胞转化成原胞还可参考[[1]](https://avogadro.cc/docs/building-materials/reducing-crystals-to-primitive-cells/)，[[2]](https://www.researchgate.net/post/How_to_convert_a_conventional_cell_to_a_primitive_cell)中的phononpy，[[3]](http://www.cryst.ehu.es/cryst/celltran.html)，以及Material Studio的CASTEP计算前检查原胞的功能。

pw.x 输入与结构有关的包括SYSTEM部分的
```
ibrav,celldm,nat,ntyp
```
以及ATOMIC_POSITIONS和CELL_PARAMETERS两部分。这里celldm代表晶格常数，单位是Bohr，设置ibrav=0用户定义cell基矢量以方便统一vc-relax和后续计算的输入文件格式，celldm(1) = 1.8897261328856432，则CELL_PARAMETERS (alat)的值以Å为单位。在结构驰豫过程中，celldm是不变的，而ATOMIC_POSITIONS是根据力而变化的，如果是vc-relax，原子坐标改变的同时，CELL_PARAMETERS则根据应力而变化。


### 1.2 结构弛豫的输入文件
pw.x处理的计算包括以下7种类型，在输入文件中用`calculation`设置：

'scf'：自洽计算，self-consistent field，通过迭代的方式数值求解微分-积分方程（Kohn-Sham方程），迭代收敛以电荷的变化足够小为准，最终得到自洽电荷。

'nscf'：非自洽计算，scf计算常在k空间的网格上进行，网格要足够密以完成k空间上的积分，在DOS等计算需要更密的k点，这时在自洽电荷基础上，计算这些更多的k点，nscf计算保持自洽电荷不变。

'bands'：也是一种nscf计算，k点按照三维k空间中的特殊路径选取。

'relax'：一系列scf计算，通过Hellman-Feynman力计算离子坐标驰豫（通过优化算法找到总能极小值点），relax计算时固定cell不变。

'vc-relax': 允许cell变化的relax，通过应力的计算改变cell。

'md'：分子动力学，将电子对离子的作用看成离子感受到的势，跟据势能和离子初始速度求解离子运动的牛顿方程。

'vc-md'：允许cell改变的md。

pw.x的输入说明见[这里](https://www.quantum-espresso.org/Doc/INPUT_PW.html)。
注意默认的单位，其中原子单位制为（以下数值见源程序q-e-qe-6.3/Modules/constants.f90）：

```
1 bohr = 1 a.u. (atomic unit) = 0.52917720859 angstroms.
1 Rydberg (Ry) = 13.60569193 eV
```

pw.x的初始晶体结构及晶格参数通常是实验值。但是，为了后续的计算可能需要通过力的弛豫（relax）得到晶格参数的理论值（如果只计算体材料能带，而所关心的问题只限于电子性质而无关晶格，使用实验值也是可以的）。这里的CELL_PARAMETER用了常见的对称写法，与上一节从cif获得的原胞等价。

结构弛豫的输入文件如下：

```
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='low'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    celldm(1) = 1.8897261328856432, ! a.u. to Angst
    nat= 2, ntyp= 2,
    occupations = 'smearing', smearing = 'gauss', degauss = 1.0d-9
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Si 28.08550 Si.UPF
  C  12.01070 C.UPF
CELL_PARAMETERS (alat=  1.88972613)
   2.174000000   2.174000000   0.000000000
   0.000000000   2.174000000   2.174000000
   2.174000000   0.000000000   2.174000000
ATOMIC_POSITIONS (crystal)
Si       0.000000000   0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
  8 8 8 0 0 0 
```

赝势文件由ld1.x生成，ld1.x的输入文件来自[pslibrary1.0](http://www.quantum-espresso.org/pseudopotentials/pslibrary)。

<a href="../../../../../img/Si.UPF">Si.UPF</a>
<a href="../../../../../img/C.UPF">C.UPF</a>

将输入文件保存成relax.inp，和两个赝势文件放在同一目录，运行```pw.x < relax.inp > relax.out``` 开始计算。（并行计算，安装了openmpi则运行```mpirun -np 16 < relax.inp > relax.out```，其中，16是使用的核数。）

在输出文件中可以找到弛豫后的晶格结构，可以看出晶格常数理论值为4.378Å。结构弛豫通过力的计算得到总能-位形曲面上的局部极小值，为了模拟实际，需要初始结构与实际情况足够接近。


```
Begin final coordinates
     new unit-cell volume =    141.54636 a.u.^3 (    20.97501 Ang^3 )
     density =      0.15834 g/cm^3

CELL_PARAMETERS (alat=  1.88972613)
   2.188890473   2.188890473   0.000000000
   0.000000000   2.188890473   2.188890473
   2.188890473   0.000000000   2.188890473

ATOMIC_POSITIONS (crystal)
Si       0.000000000  -0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
End final coordinates
```

relax计算包括多个自洽计算，查看自洽计算得到的总能用
```bash
grep '!' relax.out
```
输出为：
```
!    total energy              =     -22.67776498 Ry
!    total energy              =     -22.67819319 Ry
!    total energy              =     -22.67819977 Ry
!    total energy              =     -22.67819977 Ry
!    total energy              =     -22.67821030 Ry
```
可见，这里relax经历了了5个自洽计算步骤后达到收敛，最后一个是结构弛豫计算得到的体系总能。注意，自洽计算总能只具有相对意义，不同赝势计算得到的总能不能比较，用相同赝势计算的总能可以求差值。


#### 1.2.1 占据数、展宽的设置
对于导体，由于存在半满的能带，而只有占据的能级对于总能有贡献，费米能级附近的能级在自洽计算时可能出现相邻两次自洽迭代一次占据一次不占据，导致总能，尤其是单电子能级之和震荡的情况。计算总能时，除了使用足够密的k点网格以外，设置占据数的展宽，考虑费米能级附近的能级都对总能有一定贡献，可以让计算更容易收敛，并且得到较准确的能带和态密度。k点和展宽的设置，不仅对于总能，而且对于所有需要在整个布里渊区积分的物理量的计算收敛有影响。

建议设置```occupation='smearing',smearing='gaussian'```，使用高斯展宽。对于不同的材料调整degauss的值，对于有带隙的材料，```degauss=1d-9```，也就是接近0就可以，对于没有带隙的导体材料，degauss从小尝试到大，取值约0.01Ry量级，k点足够多的基础上（见1.2.2），测试degauss一要总能几乎不变，二要输出中的“smearing contribution TS”足够小，建议小于$1\times10^{-4}$ Ry/atom。

#### 1.2.2 自洽计算k点的设置
总能计算需要对电荷积分，由于QE中的Kohn-Sham方程是在k空间中进行的，需要在k空间均匀取点进行电荷的积分，原则上更密的网格得到的电荷更准确，但是考虑的到计算量，实际计算的k点是较为有限的，对于绝缘体，$0.5Å^{-1}$间距的k点网格一般可以实现收敛，设置

```
K_POINTS {automatic}
nk1, nk2, nk3, k1, k2, k3
```
其中，前三个数nk1, nk2, nk3是倒格子三个基矢方向的k点网格，由于对称性可能实际计算k点个数有约化，nk的值对于较长的CELL基矢方向取值较小，建议绝缘体设置k点间距在$0.5Å^{-1}$以下，对于导体，nk的值较大，需要同时结合degauss测试收敛。后三个数k1, k2, k3是设置k点网格是否含相应的0点。

### 1.3 自洽计算的输入文件
由于pw.x约定在同一目录下运行vc-relax和relax计算后的scf或bands计算会读取弛豫后的结构。所以，将calculation='vc-relax'改成calculation='scf'，其他部分与上一步输入文件相同。另外，vc-relax和relax计算最后一步包含了最终结构的scf计算，所以这里省去这一步骤。

### 1.4 能带计算的输入文件
能带计算需要设置k点路径，我们参考文献[4]给出的特殊k点坐标，选取了路径X-Γ-L。在relax计算的同一目录下，将能带计算输入文件如下保存为nscf_b.inp，运行```pw.x < nscf_b.inp > nscf_b.out```。

```
&CONTROL
    calculation='bands', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='low'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    celldm(1) = 1.8897261328856432, ! a.u. to Angst
    nat= 2, ntyp= 2,
    occupations = 'smearing', smearing = 'gauss', degauss = 1.0d-9
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Si 1.0 Si.UPF
  C  1.0 C.UPF
CELL_PARAMETERS (alat=  1.88972613)
   2.174000000   2.174000000   0.000000000
   0.000000000   2.174000000   2.174000000
   2.174000000   0.000000000   2.174000000
ATOMIC_POSITIONS (crystal)
Si       0.000000000   0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
K_POINTS {crystal_b}
3
0.5 0.0 0.5 30
0.0 0.0 0.0 30
0.5 0.5 0.5 1
```

使用QE的后处理程序bands.x将能带结果转为易于画图的格式，将以下代码保存为bds.inp，运行bands.x < bands.inp > bands.out
```
&bands
prefix='pwscf',
outdir='tmp'
filband='bd.dat'
lp=.true.
/
```
这一个步骤是读取pw.x的输出，运行成功后，会生成filband所命名的文件，这里是bd.dat，bd.dat的内容见[这里](https://github.com/yyyu200/DFTbook/blob/master/_data/HandsOn/bd.dat)，是每个k点的能级值，注意这里的能级数值只有相对的意义，能量的参考点是不确定的。通常，画能带图时，绝缘体用价带顶作为能量零点，导体用费米能级作为能量零点。接下来可以用QE自带的plotband.x画能带图，但是画图的自定义效果不够，这里不再介绍，这里为了用bd.dat画能带，使用python运行以下代码：
```python
# -*- coding: utf-8 -*-
"""
@author: yyyu200@163.com
"""

import numpy as np

feig=open('bd.dat')
ymin=-20
ymax=20
nband=4 # this is the valence band number, for insulators only
dline=30 # vertical line intervals

l=feig.readline()
nbnd=int(l.split(',')[0].split('=')[1])
nks=int(l.split(',')[1].split('=')[1].split('/')[0])

eig=np.zeros((nks,nbnd),dtype=float)
for i in range(nks):
    l=feig.readline()
    count=0
    for j in range(nbnd//10+1):
        l=feig.readline()
        for k in range(len(l.split())):
            eig[i][count]=l.split()[k]
            count=count+1
            
feig.close()

import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt

p1=plt.subplot(1, 1, 1)

F=plt.gcf()
F.set_size_inches([3,5])
lw=1.2 # line width

plt.xlim([0,nks-1]) # 201 points
plt.ylim([ymin,ymax])
#plt.xlabel(r'$k (\AA^{-1})$',fontsize=16)
plt.ylabel(r' E (eV) ',fontsize=16)

eig_vbm=max(eig[:,nband-1])
eig_cbm=min(eig[:,nband])
Gap=eig_cbm-eig_vbm

plt.title("Band gap="+str(Gap)[0:8]+" eV")  # for insulators only
for i in range(nbnd):
    line1=plt.plot( eig[:,i]-eig_vbm,color='r',linewidth=lw ) 

vline=dline
while vline<nks-1:
    plt.axvline(x=vline, ymin=ymin, ymax=ymax,linewidth=lw,color='black')
    vline=vline+dline

plt.xticks( (0,30,60), ('X', r'${\Gamma}$', 'L') )

plt.savefig('pwband.png',dpi=500)

```

计算能带结果与文献比较如下[[5]](http://www.ioffe.ru/SVA/NSM/Semicond/SiC/bandstr.html)。X-Γ带隙实验值为2.416eV，计算值为1.378eV，由于交换关联近似的原因，PBE计算出的带隙存在偏小的问题。

<p align="left">
    <img src="../../../../../img/pwband.png" width="200"/>
    <img src="../../../../../img/mband_3C_SiC.gif" width="300"/>
</p>

## 2. 计算金属铜的功函数
导体的功函数是指导体的费米能级到真空能级的差值，对于绝缘体来说，一般用类似的概念，如电离势（ionic potential）和亲和能（electron affinity）来表示价带顶和导带底与真空能级的差值。pw.x通过scf计算得到自洽电荷密度，进而得到CELL内各个点的势能，同时得到体系的费米能级。在pw.x中，由于平面波程序的周期性边界条件，能级的参考点是不确定的，所以在块材（bulk）的计算中无法得到真空能级。为了同时得到费米能级和真空能级，需要建立平板（slab）模型，在CELL中留空，留空的区域即是真空，电荷密度基本为0，所以势能是常数，即真空能级。在slab计算中费米能级（绝缘体的VBM）由于表面态的存在而不准确，而slab内的平均势能和真空平均势能是准确的；在bulk计算中，费米能级和平均势能的差值是准确的。认为slab内平均势能和bulk平均势能是对应的，则可以得到真空能级和费米能级的差值，即功函数，参考文献[6]。

功函数与晶向、重构、吸附等密切相关，这里考虑金属Cu未重构的（110）表面，对于绝缘体的电离势可以通过类似方法得到。

### 2.1 计算铜的晶格常数、能带和态密度
用首先计算面心立方铜的原胞，用```calculation='vc-relax'```优化晶格常数。实验晶格常数为3.61Å。
```
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='low'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    celldm(1) = 1.8897261328856432, ! a.u. to Angst
    nat= 1, ntyp= 1,
    occupations = 'smearing', smearing = 'gauss', degauss = 1.0d-2
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Cu 63.546 Cu.UPF
CELL_PARAMETERS (alat=  1.88972613)
  1.8050000   1.8050000   0.0000000 
  1.8050000   0.0000000   1.8050000 
  0.0000000   1.8050000   1.8050000 
ATOMIC_POSITIONS (crystal)
Cu  0.000000000   0.000000000   0.000000000
K_POINTS {automatic}
  13 13 13 0 0 0 
```

用PBE交换关联近似计算得到晶格常数理论值是3.6232Å。运行```grep 'smearing contrib.' vc.out ```，
```
     smearing contrib. (-TS)   =      -0.00021395 Ry
     smearing contrib. (-TS)   =      -0.00021409 Ry
     smearing contrib. (-TS)   =      -0.00021414 Ry
     smearing contrib. (-TS)   =      -0.00021413 Ry
     smearing contrib. (-TS)   =      -0.00021411 Ry
```
结果在可接受范围。

运行```grep Fermi vc.out |tail -1```，得到费米能级。
```
     the Fermi energy is    12.6479 ev
```

计算态密度，nscf.inp输入如下，使用了$53^{3}=148877$个k点的网格，以得到较为平滑的DOS曲线。
```
&CONTROL
    calculation='nscf', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='low'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    celldm(1) = 1.8897261328856432, ! a.u. to Angst
    nat= 1, ntyp= 1,
    occupations = 'smearing', smearing = 'mp', degauss = 2.5d-2
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Cu 63.546 Cu.UPF
CELL_PARAMETERS (alat=  1.88972613)
  1.8050000   1.8050000   0.0000000
  1.8050000   0.0000000   1.8050000
  0.0000000   1.8050000   1.8050000
ATOMIC_POSITIONS (crystal)
Cu  0.000000000   0.000000000   0.000000000
K_POINTS {automatic}
  53 53 53 0 0 0
```
将以下输入参数保存为dos.inp，运行```dos.x < dos.inp > dos.out```

```
&dos 
 prefix='pwscf'
 outdir='./tmp'
 ngauss=1
 degauss=1.5d-2
 DeltaE=1.0d-2
 fildos='cu.dos'
/ 
```

将nscf计算输入中K_POINTS改为如下，设置```calculation='bands'```，计算能带。
```
K_POINTS {crystal_b}
6
0.5 0.5 0.5 50
0.0 0.0 0.0 50
0.5 0.0 0.5 20
0.625 0.25 0.625 0
0.375 0.375 0.75 50
0.0 0.0 0.0 1
```

计算得到的能带和态密度如下图，画图时要删掉第120个k点（U点）的能级。
<p align="left">
    <img src="../../../../../img/pwbanddos.png" width="1000"/>
</p>

### 2.2 建立slab模型并做结构驰豫
建立slab模型的一般方法见[这里](../../07/TransCell/#平板slab模型的建立)。建立slab模型使用前一节得到的理论晶格常数，先对原胞做变换$$P_{1}$$得到晶胞，再做变换$$P_{2}$$得到(110)方向长度为19个原子的超胞，最后加上20Å的真空，得到slab模型，其中

$$
P_{1}=\quad
\begin{pmatrix}
-1 & 1 & 1 \\
 1 &-1 & 1 \\
 1 & 1 &-1 \\
\end{pmatrix}
Q_{1}=\quad
\begin{pmatrix}
0 & 1 \over 2 & 1 \over 2 \\
1 \over 2 & 0 & 1 \over 2 \\
1 \over 2 & 1 \over 2 & 0 \\
\end{pmatrix}
\quad 
P_{2}=\quad
\begin{pmatrix}
1 & 0 & 0 \\
0 & 1 \over 2  & 5 \\
0 & - {1\over 2} & 5 \\
\end{pmatrix}
\quad
Q_{2}=\quad
\begin{pmatrix}
1 & 0 & 0 \\
0 & 1 & -1 \\
0 & 0.1 & 0.1 \\
\end{pmatrix}
\quad
$$

在VESTA中输入P2变换矩阵，并以POSCAR格式输出得到：
```
New structure
1.0
        3.6231999397         0.0000000000         0.0000000000
        0.0000000000         2.5619893074         0.0000000000
        0.0000000000         0.0000000000        25.6198921204
   Cu
   20
Direct
     0.000000000         0.000000000         0.000000000
     0.000000000         0.000000000         0.100000001
     0.500000000         0.500000000         0.050000001
     0.000000000         0.000000000         0.899999976
     0.500000000         0.500000000         0.449999988
     0.500000000         0.500000000         0.550000012
     0.000000000         0.000000000         0.200000003
     0.500000000         0.500000000         0.649999976
     0.500000000         0.500000000         0.949999988
     0.500000000         0.500000000         0.150000006
     0.000000000         0.000000000         0.500000000
     0.000000000         0.000000000         0.600000024
     0.000000000         0.000000000         0.800000012
     0.000000000         0.000000000         0.300000012
     0.500000000         0.500000000         0.250000000
     0.500000000         0.500000000         0.850000024
     0.000000000         0.000000000         0.699999988
     0.000000000         0.000000000         0.400000006
     0.500000000         0.500000000         0.349999994
     0.500000000         0.500000000         0.750000000
```
<p align="left">
    <img src="../../../../../img/cu110slab.png" width="1000"/>
</p>

加入真空时，CELL的面内基矢不变，删掉最顶端的一个原子，以保持slab的两个表面的对称性，不引入两个表面不对称会形成的偶极场（对于Cu的110面这个例子，由于对z方向做镜面加平移可以复原，不删除这个原子两个表面也是等势能的），z方向增加20Å，原子分数坐标随之变换。得到输入文件如下，这里的结构驰豫应该用```calculation='relax'```进行。在早期的研究中，常固定slab内部原子，只允许最接近表面的1～2层原子驰豫。现在常固定中间一个原子，等效于所有原子允许驰豫，可以避免slab的整体漂移。

```
&CONTROL
    calculation='relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='low'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-4
/
&SYSTEM
    ibrav= 0,
    celldm(1) = 1.8897261328856432, ! a.u. to Angst
    nat= 19, ntyp= 1,
    occupations = 'smearing', smearing = 'gauss', degauss = 1.0d-2
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Cu 63.546 Cu.UPF
CELL_PARAMETERS (alat=  1.88972613)
  3.6231999397  0.0000000000   0.0000000000
  0.0000000000  2.5619893074   0.0000000000
  0.0000000000  0.0000000000  43.0579029084
K_POINTS {automatic}
  8 8 1 0 0 0 
ATOMIC_POSITIONS (crystal)
Cu  0.000000000    0.000000000    0.232245403
Cu  0.000000000    0.000000000    0.291746425
Cu  0.500000000    0.500000000    0.261995914
Cu  0.000000000    0.000000000    0.767754583
Cu  0.500000000    0.500000000    0.499999993 0 0 0
Cu  0.500000000    0.500000000    0.559501029
Cu  0.000000000    0.000000000    0.351247448
Cu  0.500000000    0.500000000    0.619002029
Cu  0.500000000    0.500000000    0.321496939
Cu  0.000000000    0.000000000    0.529750511
Cu  0.000000000    0.000000000    0.589251547
Cu  0.000000000    0.000000000    0.708253583
Cu  0.000000000    0.000000000    0.410748475
Cu  0.500000000    0.500000000    0.380997957
Cu  0.500000000    0.500000000    0.738004101
Cu  0.000000000    0.000000000    0.648752547
Cu  0.000000000    0.000000000    0.470249493
Cu  0.500000000    0.500000000    0.440498975
Cu  0.500000000    0.500000000    0.678503065
```

### 2.3 获取静电势并得到功函数
用pp.x得到静电势，如下文件保存为pp.inp，运行```pp.x < pp.inp > pp.out```，

```
&INPUTPP
   outdir='./tmp'
   plot_num=11
   filplot='pp11.dat'
/
```
得到输出势能文件pp11.dat，其中文件的第三行有误，
```
     0        6.84685561      0.70710680     11.88394337      0.00000000      0.00000000      0.00000000
```
改成

```
     0        1.88972613      0.00000000      0.00000000      0.00000000      0.00000000      0.00000000
```
分别是ibrav和celldm(6)的值。

用average.x对面内势能取平均，并对垂直表面方向势能取移动平均值，average.x输入说明见[这里](https://github.com/QEF/q-e/blob/master/PP/src/average.f90)，输入文件average.inp如下，运行```average.x< average.inp >average.out```：

```
1
pp11.dat
1
1000
3
4.8681
```

其中，最后一行4.8681是移动平均的窗口长度,设置为驰豫后slab中间部分的周期单元长度，单位是Bohr。输出avg.dat见[这里](../../../../../img/avg.dat)，包括三列，第一列是z方向格点，第二列是势能在xy面内的平均，第三列是z方向移动平均。通过进一步拟合，得到slab中间势能为-0.007Ry，真空势能为0.7044Ry。对于原胞的平均静电势能，可以对势能直接求平均值，得到原胞的平均势能是0.52914Ry，由前面计算得到原胞费米能级12.6479eV=0.9296Ry。

slab中费米能级是5.2153eV，不加原胞修正的功函数是4.369eV。

而加了原胞修正的功函数为：

$$0.7044-0.9296+[0.52914-(-0.007)]=0.311Ry=4.321eV$$.

势能作图如下，红色线是xy面内平均势能，蓝色线是z方向移动平均，绿色线是slab内部平均势能示意。

<p align="left">
    <img src="../../../../../img/cu_110avg.png" width="1000"/>
</p>

## 3. 计算氮化硼的光学性质

计算闪锌矿结构立方氮化硼的介电函数。

### 3.1 用epsilon.x计算光学性质
epsilon.x计算能级间偶极跃迁得到介电常数，根据以下公式得到介电常数虚部[7]：

$\epsilon_2 (\omega)= \frac{4 \pi ^2} {m^2\omega^2} \sum_{V,C} {\int_{BZ} {d^3 k  \frac {2}{(2\pi)^{3}}  \lvert eM_{CV}(K) \rvert ^2 \cdot \delta[E_{C}(k)-E_{V}(k)-h\omega]}}$

而介电常数实部可以由虚部通过Kramers-Kronig关系变换得到。通过能带结构，可以计算得到全部的光学常数。

epsilon.x计算目前仅支持模守恒赝势。首先优化晶格常数，运行```pw.x < vc.inp > vc.out```，vc.inp如下：
```
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    celldm(1) = 1.8897261328856432, ! a.u. to Angst
    nat= 2, ntyp= 2,
    occupations = 'fixed'
    ecutwfc= 80, ecutrho = 320,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  B  10.811   B_ONCV_PBE-1.0.upf  
  N  14.00674 N.oncvpsp.upf
CELL_PARAMETERS (alat=  1.88972613)
   1.807500000   1.807500000  -0.000000000
   0.000000000   1.807500000   1.807500000
   1.807500000  -0.000000000   1.807500000
ATOMIC_POSITIONS (crystal)
B        0.000000000   0.000000000   0.000000000
N        0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
  13 13 13 1 1 1

```
赝势文件见
[B_ONCV_PBE-1.0.upf](../../../../../img/B_ONCV_PBE-1.0.upf)
[N.oncvpsp.upf](../../../../../img/N.oncvpsp.upf)。

得到晶格常数PBE计算值3.6215Å。光学性质需要较密的k点，并且需要关掉对称性，设置```nosym=.true,noinv=.true```，计算的带个数nbnd要大一些，做一次nscf计算：
```
&CONTROL
    calculation='nscf', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    celldm(1) = 1.8897261328856432, ! a.u. to Angst
    nat= 2, ntyp= 2,
    occupations = 'smearing', smearing='gauss', degauss=1d-9,
    ecutwfc= 80, ecutrho = 320,
    nbnd=30
    nosym=.true,
    noinv=.true,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  B  10.811   B_ONCV_PBE-1.0.upf  
  N  14.00674 N.oncvpsp.upf
CELL_PARAMETERS (alat=  1.88972613)
   1.810733563   1.810733563   0.000000000
  -0.000000000   1.810733563   1.810733563
   1.810733563  -0.000000000   1.810733563
ATOMIC_POSITIONS (crystal)
B        0.000000000   0.000000000   0.000000000
N        0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
  13 13 13 0 0 0
```
以下内容保存为epsilon.inp，运行epsilon.x < epsilon.inp > epsilon.out：
```
&inputpp
  outdir='./tmp'
  calculation='eps'
/
&energy_grid
  smeartype='gauss'
  intersmear=0.50
  intrasmear=0.0
  wmin=0.0
  wmax=60.0
  nbndmin=1
  nbndmax=0
  nw=2000
  shift=0.0
/
```
输出4个文件eels_pwscf.dat,epsi_pwscf.dat,epsr_pwscf.dat,ieps_pwscf.dat，分别是eels谱（电子能量损失谱），介电函数的虚部、实部，虚轴上的介电函数。前三个结果见下图，与实验及其他计算结果比较见[8]。

<p align="left">
    <img src="../../../../../img/bn_epsilon.png" width="1000"/>
</p>

固体介电常数、电导率、折射率一般来说都是复数，知道其一可以确定其余两个，进而还可以得到吸收系数，反射率，三者关系如下表[9]：

<p align="left">
    <img src="../../../../../img/optic_relation.png" width="1000"/>
</p>

吸收系数 $\alpha= \frac{2k \omega }{c}$

反射率 $R=\frac{(1-n)^2+k^2}{(1+n)^2+k^2}$

### 3.2 用tddfpt计算光学性质（待续）

## 4. 声子谱的计算
计算GaAs的声子谱。QE中声子计算是通过DFPT进行的，通过加入berry phase电场计算电荷响应得到介电常数，新版本（>=6.x）也开始支持finite displacements method。参考安装包q-e-qe-6.3\PHonon\examples\ example1 （$\Gamma$点）和example2 （色散），画图这里用的是python。

首先优化晶格常数，用pw.x进行一次vc-relax计算（晶格常数实验值5.715Å，计算值5.585Å）。GGA计算出的极化往往较实际偏大而LDA偏小，在极化$4\pi P$接近电位移矢量D时介电常数发散（$4\pi P$总是小于D），$\epsilon=1+\frac{4\pi P}{D-4\pi P}$，所以极化偏大对介电常数影响较大。这里GaAs按照文献中的做法使用了LDA模守恒赝势，赝势文件见[Ga](../../../../../img/Ga.SG15.LDA.UPF)，[As](../../../../../img/As.SG15.LDA.UPF)。

```
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5, etot_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 2,
    celldm(1) = 10.7997848
    nat= 2, ntyp= 2,
    occupations = 'fixed', nbnd=10
    ecutwfc= 120, ecutrho = 480,
    input_dft='pz'
/
&ELECTRONS
    electron_maxstep = 100,    conv_thr = 1.0d-9,    mixing_mode = 'plain'
    mixing_beta = 0.7d0,    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
   press = 0.00 ,
   press_conv_thr=0.1
   cell_dynamics = 'bfgs' ,
/
ATOMIC_SPECIES
 Ga  69.7230 Ga.SG15.LDA.UPF
 As  74.9216 As.SG15.LDA.UPF
ATOMIC_POSITIONS (crystal)
Ga       0.000000000   0.000000000   0.000000000 0 0 0
As       0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
11 11 11 1 1 1
```

### 4.1 单个q点的ph.x计算

vc-relax计算之后用最终结构做一次scf计算（否则后续计算会出错）。

将以下文件保存为ph.inp，运行```ph.x < ph.inp > ph.out```

```
phonons of GaAs at Gamma
 &inputph
  tr2_ph=1.0d-14,
  prefix='pwscf',
  outdir='./tmp',
  epsil=.true.,
  amass(1)=69.7230,
  amass(2)=74.9216,
  fildyn='gs.dynG',
 /
0.0 0.0 0.0
```

在输出ph.out中可以找到高频介电常数张量$\epsilon_{ij}(\infty)$（实验值10.86，Ref.[10]），以及玻恩有效电荷张量$Z_{ij}$（实验值2.07）：
```
          Dielectric constant in cartesian axis 

          (      13.578406136      -0.000000000       0.000000000 )
          (      -0.000000000      13.578406136      -0.000000000 )
          (       0.000000000      -0.000000000      13.578406136 )

          Effective charges (d Force / dE) in cartesian axis

           atom      1   Ga 
      Ex  (        2.04400        0.00000        0.00000 )
      Ey  (        0.00000        2.04400       -0.00000 )
      Ez  (        0.00000       -0.00000        2.04400 )
           atom      2   As 
      Ex  (       -2.04051       -0.00000       -0.00000 )
      Ey  (       -0.00000       -2.04051        0.00000 )
      Ez  (       -0.00000        0.00000       -2.04051 )
```

此时计算出$\Gamma$点声子频率。但是，可以看到$\Gamma$点声学声子不等于0，且没有LO-TO分裂，为了加入Acoustic Sum Rule和non-analytic term修正，将以下文件保存为dynmat.inp。在声子平衡位置，由对称性可知LO与TO是简并的。但是，LO与长程库仑作用耦合而TO不耦合造成LO-TO分裂[11]，q(1,2,3)是LO-TO分裂的方向，对于立方晶系各向同性不全等于0即可，运行```dynmat.x < dynmat.inp > dynmat.out```

```
&input
  fildyn='gs.dynG'
  q(1)=0,q(2)=0,q(3)=0.1
  asr='crystal'
  filout='dynmat.dat'
/
```

输出的dynmat.out中可以找到$\Gamma$点声子频率如下（实验值：TO=271$cm^{-1}$，LO=293$cm^{-1}$）。第三列是红外强度。

```
# mode   [cm-1]    [THz]      IR
    1     -0.00   -0.0000    0.0000
    2      0.00    0.0000    0.0000
    3      0.00    0.0000    0.0000
    4    259.42    7.7771    2.6645
    5    259.42    7.7771    2.6645
    6    277.32    8.3139    2.6645
```

### 4.2 声子色散计算
首先，用ph.x在q点网格上通过DFPT计算动力学矩阵，输入ph.inp如下（需要在scf计算之后运行，如果接在vc-relax之后运行ph.x，运行q2r.x时会出错），运行```ph.x < ph.inp > ph.out```：

```
phonons of GaAs q-grid
 &inputph
  tr2_ph=1.0d-12,
  prefix='pwscf',
  outdir='./tmp',
  amass(1)=69.7230,
  amass(2)=74.9216,
  fildyn='gs666.dyn',
  ldisp=.true.,
  nq1=6, nq2=6, nq3=6
 /
```

ph.x计算结束后（这一步计算量很大），用q2r.x将动力学矩阵由q空间变换到实空间，输入q2r.inp如下，运行```q2r.x < q2r.inp > q2r.out```：
```
 &input
   fildyn='gs666.dyn', zasr='simple', flfrc='gs666.fc'
 /
```

matdyn.x通过实空间nq1×nq2×nq3超胞上interatomic force constants计算任意q点声子频率。将以下保存为matdyn.inp，运行```matdyn.x < matdyn.inp > matdyn.out```，计算声子色散，q点定义见安装包[/Doc/brillouin_zones.pdf](https://gitlab.com/QEF/q-e/blob/develop/Doc/images/fcc_sc.png)。

```
&input
  asr='simple',
  amass(1)=69.7230,
  amass(2)=74.9216,
  flfrc='gs666.fc',
  flfrq='gs.freq',
  q_in_band_form=.true.,
/
6
  gG    40
  X     10
  U      0
  K     40
  gG    40
  L     1
```
声子色散见下图，画图时要删掉第50个（U点）和第51个（K点）q点中的一个，结果与文献中比较见[10]。matdyn.x也可以用来计算声子态密度。

<p align="left">
    <img src="../../../../../img/gaas_phonon.png" width="1000"/>
</p>

## 5. 杂化泛函和Wannier函数

HSE06是一种杂化泛函（Hybrid functional），其中交换作用短程部分用GGA和Hatree-Fock的混合，长程部分使用GGA，关联则统一使用GGA。HSE06相对于GGA计算结果，总能和力的准确度有系统性的提升[12]。Wannier基函数是与平面波基函数可以相互变换的完备基，是一种局域轨道基函数[13]。

计算前需要编译wannier90模块，QE目录运行```make w90```。这里参考安装包中的例子q-e-qe-6.3/PW/examples/EXX_example以及q-e-qe-6.3/W90/examples/example03和example05。

计算HSE能带有以下四步：
1. 用pw.x运行‘scf’/‘nscf’。
2. 运行wannier90.x -pp (或输入文件内postproc_setup = .true.)生成seedname.nnkp。
3. 运行pw2wannier90.x读入pw输出文件、seedname.pw2wan和seedname.nnkp, 生成seedname.mmn, seedname.amn和seedname.eig。
4. 运行wannier90.x得到能带。

### 5.1 杂化泛函自洽计算

用HSE06进行scf计算，运行pw.x，输入如下，这里采用了pslibrary1.0的超软赝势，采用了PBE的晶格常数（见第1.4节），也可以用HSE06做vc-relax或状态方程计算，计算需要关掉对称性，得到完整的k网格（4×4×4=64个k点）：
```
&CONTROL
    calculation='scf', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    celldm(1) = 1.8897261328856432, ! a.u. to Angst
    nat= 2, ntyp= 2,
    occupations = 'smearing', smearing = 'gauss', degauss = 1.0d-9
    ecutwfc= 50, ecutrho = 500,
    input_dft='hse'
    exxdiv_treatment = 'gygi-baldereschi'
    ecutvcut = 0.7
    x_gamma_extrapolation = .true.
    nqx1=4, nqx2=4, nqx3=4,
nosym=.true.
nosym_evc=.true.
noinv=.true.
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Si 28.08550 Si.UPF
  C  12.01070 C.UPF
ATOMIC_POSITIONS (crystal)
Si       0.000000000   0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
  4 4 4 0 0 0 
CELL_PARAMETERS (alat=  1.88972613)
   2.188890473   2.188890473   0.000000000
   0.000000000   2.188890473   2.188890473
   2.188890473   0.000000000   2.188890473
```

### 5.2 提取Wannier函数并计算能带

输入文件sc.win如下，其中```mp_grid      = 4 4 4```要与HSE06的scf计算中k点一致，```kpoints```采用pw输出的k点，运行```wannier90.x -pp sc```：

```
num_bands         =   8      
num_wann          =   8

dis_win_max       = 17.0d0
dis_froz_max      =  6.4d0
dis_num_iter      =  120
dis_mix_ratio     = 1.d0

num_iter          = 50
num_print_cycles  = 10

Begin Atoms_Frac
Si       0.000000000   0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
End Atoms_Frac
    
Begin Projections     
Si : sp3 
C  : sp3 
End Projections       
    
begin kpoint_path
L 0.50000  0.50000 0.5000 G 0.00000  0.00000 0.0000
G 0.00000  0.00000 0.0000 X 0.50000  0.00000 0.5000
X 0.50000 -0.50000 0.0000 K 0.37500 -0.37500 0.0000 
K 0.37500 -0.37500 0.0000 G 0.00000  0.00000 0.0000
end kpoint_path

!bands_plot = .true.

Begin Unit_Cell_Cart
   2.188890473   2.188890473   0.000000000
   0.000000000   2.188890473   2.188890473
   2.188890473   0.000000000   2.188890473
End Unit_Cell_Cart

mp_grid      = 4 4 4

begin kpoints
 0.0000000   0.0000000   0.0000000
 0.0000000   0.0000000   0.2500000
 0.0000000   0.0000000  -0.5000000
 0.0000000   0.0000000  -0.2500000
 0.0000000   0.2500000   0.0000000
 0.0000000   0.2500000   0.2500000
 0.0000000   0.2500000  -0.5000000
 0.0000000   0.2500000  -0.2500000
 0.0000000  -0.5000000   0.0000000
 0.0000000  -0.5000000   0.2500000
 0.0000000  -0.5000000  -0.5000000
 0.0000000  -0.5000000  -0.2500000
 0.0000000  -0.2500000   0.0000000
 0.0000000  -0.2500000   0.2500000
 0.0000000  -0.2500000  -0.5000000
 0.0000000  -0.2500000  -0.2500000
 0.2500000   0.0000000   0.0000000
 0.2500000   0.0000000   0.2500000
 0.2500000   0.0000000  -0.5000000
 0.2500000   0.0000000  -0.2500000
 0.2500000   0.2500000   0.0000000
 0.2500000   0.2500000   0.2500000
 0.2500000   0.2500000  -0.5000000
 0.2500000   0.2500000  -0.2500000
 0.2500000  -0.5000000   0.0000000
 0.2500000  -0.5000000   0.2500000
 0.2500000  -0.5000000  -0.5000000
 0.2500000  -0.5000000  -0.2500000
 0.2500000  -0.2500000   0.0000000
 0.2500000  -0.2500000   0.2500000
 0.2500000  -0.2500000  -0.5000000
 0.2500000  -0.2500000  -0.2500000
-0.5000000   0.0000000   0.0000000
-0.5000000   0.0000000   0.2500000
-0.5000000   0.0000000  -0.5000000
-0.5000000   0.0000000  -0.2500000
-0.5000000   0.2500000   0.0000000
-0.5000000   0.2500000   0.2500000
-0.5000000   0.2500000  -0.5000000
-0.5000000   0.2500000  -0.2500000
-0.5000000  -0.5000000   0.0000000
-0.5000000  -0.5000000   0.2500000
-0.5000000  -0.5000000  -0.5000000
-0.5000000  -0.5000000  -0.2500000
-0.5000000  -0.2500000   0.0000000
-0.5000000  -0.2500000   0.2500000
-0.5000000  -0.2500000  -0.5000000
-0.5000000  -0.2500000  -0.2500000
-0.2500000   0.0000000   0.0000000
-0.2500000   0.0000000   0.2500000
-0.2500000   0.0000000  -0.5000000
-0.2500000   0.0000000  -0.2500000
-0.2500000   0.2500000   0.0000000
-0.2500000   0.2500000   0.2500000
-0.2500000   0.2500000  -0.5000000
-0.2500000   0.2500000  -0.2500000
-0.2500000  -0.5000000   0.0000000
-0.2500000  -0.5000000   0.2500000
-0.2500000  -0.5000000  -0.5000000
-0.2500000  -0.5000000  -0.2500000
-0.2500000  -0.2500000   0.0000000
-0.2500000  -0.2500000   0.2500000
-0.2500000  -0.2500000  -0.5000000
-0.2500000  -0.2500000  -0.2500000
End Kpoints
```

以下文件保存为pw2wan.inp，运行```pw2wannier90.x < pw2wan.inp > pw2wan.out```：

```
&inputpp
   outdir = './tmp'
   prefix = 'pwscf'
   seedname = 'sc'
   spin_component = 'none'
   write_mmn = .true.
   write_amn = .true.
   write_unk = .true.
/
```

将sc.win中的```!bands_plot = .true.```注释叹号删去，再运行一次```wannier90.x sc```，得到wannier基函数的能带值sc_band.dat，用这个文件画图，gnuplot输入文件如下：

```
reset
set terminal pngcairo size 580,880 enhanced font 'Times-Roman,15'
set output "out.png"

set style data dots
set nokey

set label "SiC HSE06   Eg=2.15eV" at graph 0.05,graph 0.96

set xrange [0: 4.70794]
!set yrange [ -20.0 : 20.0]
set yrange [ -20 : 20]
set arrow from  1.24296,  -20.0 to  1.24296,  20.0 nohead
set arrow from  2.67820,  -20.0 to  2.67820,  20.0 nohead
set arrow from  3.18564,  -20.0 to  3.18564,  20.0 nohead
set xtics ("L"  0.00000,"{/Symbol G}"  1.24296,"X"  2.67820,"K"  3.18564,"{/Symbol G}"  4.70794)
 plot "sc_band.dat" using 1:($2-0.88318010E+01) with lines lt 1  lw 2 lc rgb "red"
```

结果如下图，带隙值与PBE（见1.4节）相比有所提升。

<p align="left">
    <img src="../../../../../img/sc_hseband.png" width="580"/>
</p>

## 6. 波函数投影

对于QE计算的波函数是以平面波基组表示的，而原子轨道会有更好的直观性和可解释性，可以将各个k点的各个能级的波函数，投影到以各个原子坐标为中心的s、p、d、f等球谐函数上（以及非共线和磁性计算），即为（local）projected density of states，用projwfc.x模块计算，下面以$SnO_{2}$(rutile)的投影态密度为例。

做vc-relax，输入文件如下：

```Fortran
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5, etot_conv_thr=1.0d-5, nstep=100,
/
&SYSTEM
    ibrav= 6,
    celldm(1)=8.952142,
    celldm(3)=0.672620,
    nat= 6,
    ntyp= 2,
    occupations = 'fixed', nbnd=32,
    ecutwfc= 100, ecutrho = 1200,
/
&ELECTRONS
    electron_maxstep = 100,    conv_thr = 1.0d-9,    mixing_mode = 'plain'
    mixing_beta = 0.7d0,    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
   press = 0.00 ,
   press_conv_thr=0.1
   cell_dynamics = 'bfgs' ,
/
ATOMIC_SPECIES
  Sn 118.710  Sn.pbe-dn-rrkjus_psl.1.0.0.UPF
  O   15.999  O.pbe-n-rrkjus_psl.1.0.0.UPF
ATOMIC_POSITIONS (crystal)
Sn  0.000000   0.000000   0.000000
Sn  0.500000   0.500000   0.500000
O   0.307000   0.307000   0.000000
O  -0.307000  -0.307000   0.000000
O   0.193000   0.807000   0.500000
O   0.807000   0.193000   0.500000
K_POINTS {automatic}
  6 6 9 0 0 0
```

计算DOS需要较密的k点，再做一次nscf计算，k点设置为

```
K_POINTS {automatic}
  13 13 20 0 0 0
```

以下文件保存为proj.inp，运行```mpirun projwfc.x <proj.inp >proj.out```。

```
&PROJWFC
prefix='pwscf',
outdir='./tmp',
ngauss=0,
degauss=0.01,
DeltaE=0.005
lsym=.true.
filpdos='sno',
filproj='sno',
/
```

用以下Python程序画图：

```python
#!/bin/env python
# -*- coding: utf-8 -*-

import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt
import numpy as np

lw=1.2

F=plt.gcf()
F.clf()
p=plt.subplot(1, 1, 1)

# change by-hand here, read scf input in the future
elem=['Sn','O']
ielem=np.array([2,4],dtype=np.int32) # number of atoms for each element
iorb=np.array([3,2],dtype=np.int32) # number of projectors for each element
orb=[['s','p','d'],['s','p']]  # projectors for each element


num_file=np.dot(ielem,iorb)
nat=np.sum(ielem)
D=[]
N=len(elem)

#scf atomic_positions should be sorted in the same order as above
count=0
count_at=0
for k in range(N):
    for i in range(ielem[k]):
        for j in range(iorb[k]):
            print(k,i,j,count_at+1,elem[k],j+1,orb[k][j])
            fname='sno.pdos_atm#{}({})_wfc#{}({})'.format(count_at+1,elem[k],j+1,orb[k][j])
            D.append(np.loadtxt(fname,dtype=np.float32))
            count+=1
        count_at+=1

line1=plt.plot(D[0][:,0]-8.7233,D[0][:,1]+D[3][:,1],color='g',linewidth=lw,label='Sn s' )
line2=plt.plot(D[0][:,0]-8.7233,D[1][:,1]+D[4][:,1],color='r',linewidth=lw,label='Sn p' )
line3=plt.plot(D[0][:,0]-8.7233,D[2][:,1]+D[5][:,1],color='b',linewidth=lw,label='Sn d' )

line4=plt.plot(D[0][:,0]-8.7233,D[6][:,1]+D[8][:,1]+D[10][:,1]+D[12][:,1],color='cyan',linewidth=lw,label='O s' )
line5=plt.plot(D[0][:,0]-8.7233,D[7][:,1]+D[9][:,1]+D[11][:,1]+D[13][:,1],color='grey',linewidth=lw,label='O p' )
plt.xlim([-10,7])
plt.ylim([0,10.5])

plt.ylabel(r'DOS (a.u.)',fontsize=16)
plt.xlabel(r'E (eV) ',fontsize=16)
plt.legend()
plt.savefig('pdos.png',dpi=200)
```

结果如图所示。
<p align="left">
    <img src="../../../../../img/sno_pdos.png" width="1000"/>
</p>

在能带计算之后，用projwfc.x生成的sno.projwfc_up文件，可以和bands.x生成的文件bd.dat结合画出各个能带的原子轨道投影。


## 7. 点缺陷的计算
缺陷的形成能是含缺陷体系和参考体系之间的总能差值。点缺陷的形成能计算公式为[14]：
$E^f[X^q] = E_{tot}[X^q]-E_{tot}[bulk]-\sum_i n_i \mu_i + q \left(E_{VBM} + \mu_e \right) + E_{corr} $

等号右边第一项是具有点缺陷$X^q$的超胞的总能，第二项是不含缺陷的超胞总能，$n_i$是两个超胞第i种元素原子个数之差，$\mu_i$是第i种元素的化学势，$E_{VBM}$是价带顶能级位置，$\mu_e$是以价带顶为参考点的电子化学势，$E_{corr}$是有限尺寸修正项。

## References

1. https://avogadro.cc/docs/building-materials/reducing-crystals-to-primitive-cells/

2. https://www.researchgate.net/post/How_to_convert_a_conventional_cell_to_a_primitive_cell 

3. Bilbao, http://www.cryst.ehu.es/cryst/celltran.html

4. Wahyu Setyawan, Stefano Curtarolo, High-throughput electronic band structure calculations: Challenges and tools. Computational Materials Science 49 (2010) 299–312.(doi:[10.1016/j.commatsci.2010.05.010](https://www.sciencedirect.com/science/article/pii/S0927025610002697)).

5. http://www.ioffe.ru/SVA/NSM/Semicond/SiC/bandstr.html

6. Sgiarovello, C., Binggeli, N., Baldereschi, A. (2004). Surface morphology and ionization potentials of polar semiconductors: The case of GaAs. Physical Review B, 69(3). doi:[10.1103/PhysRevB.69.035320](http://dx.doi.org/10.1103/PhysRevB.69.035320).

7. F. Bassani, G. Parravicini, Electronic states and optical transitions in solids. Pergamon Press (1975).

8. Anna Tararan et al. *Optical gap and optically active intragap defects in cubic BN*. [Phys. Rev. B 98, 094106 (2018).](http://dx.doi.org/10.1103/PhysRevB.98.094106)

9. Martin Dressel, George Gruner, *Electrodynamics of Solids-Optical Properties of Electrons in Matter*. Cambridge University Press (2002).

10. P. Giannozzi et al, *Ab initio calculation of phonon dispersions in semiconductors.* [Phys. Rev. B **43**, 7231 (1991).](http://dx.doi.org/10.1103/PhysRevB.43.7231). L. Lindsay et al, *Ab initio thermal transport in compound semiconductors.* [Physical Review B **87**,165201 (2013)](http://dx.doi.org/10.1103/PhysRevB.87.165201).

11. P.Y. Yu, M. Cardona, *Fundamentals of Semiconductors: Physics and Materials Properties*, Springer, 2010.

12. J. Paier et al, Screened hybrid density functionals applied to solids, The Journal of Chemical Physics 124, 154709 (2006); doi: [10.1063/1.2187006](http://dx.doi.org/10.1063/1.2187006).

13. Marzari et al, Maximally localized Wannier functions: Theory and applications, [Rev. Mod. Phys. **84**, 1419 (2012)](https://link.aps.org/doi/10.1103/RevModPhys.84.1419).

14. Christoph Freysoldt, Blazej Grabowski, Tilmann Hickel, Jörg Neugebauer, Georg Kresse, Anderson Janotti, and Chris G. Van De Walle. First-principles calculations for point defects in solids. Rev. Mod. Phys., 86(1):253–305, 2014. [doi:10.1103/RevModPhys.86.253](http://dx.doi.org/10.1103/RevModPhys.86.253).

Update On 2019/06/18

